<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Trendline</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.3.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
        <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
        <script>
            var _trendlineData = null;
            var _chart = null;
            var _exceptionTypes =[];
            var _locid ='';
            var _chartDataset = {
                    exceptionType:'',
                    dataSet:[],
                    dateSeries:[]
                };
            var _currentDateRange ={
                fDate:null,tDate:null
            }
            function readTrendlineData(){  
                
               // var url = "https://services3.arcgis.com/5IIttubzVsJ0uEuF/ArcGIS/rest/services/trendlines_dev_2024_1_1/FeatureServer/0/query?where=Title='Motor RPM'&objectIds=&resultType=none&outFields=*&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=true&cacheHint=false&collation=&orderByFields=Date&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson&token=";
               var url = 'trendlines_dev_2024_1.csv';
                var xhttp = new XMLHttpRequest();
                xhttp.open('GET',url,true);
                xhttp.onload = function() {
                   // var geoData = JSON.parse(this.responseText);
                    //alert(geoData.features[0].properties['ID'])
                    
                    //onLoad(geoData);
                    parseCSV(this.responseText);
                    //displayJSONAsTable(geoData.features[0].properties);
                }
                xhttp.send();
            }
            function parseCSV(csvData){
                Papa.parse(csvData, {
                        header: true, // Set to false if no headers in the CSV
                        skipEmptyLines: true,
                        complete: function (results) {
                            console.log(results.data); // Parsed data
                            _trendlineData = results.data;
                            onLoad(results.data);
                            //document.getElementById("output").textContent = JSON.stringify(results.data, null, 2);
                        },
                        error: function (error) {
                            console.error("Error parsing CSV:", error);
                        }
                    });
            }
            function onDateChange(){
                var dateRange = getSliderRange();
                
                selectedLoad(_currentDateRange.fDate,_currentDateRange.tDate);
            }
            function getDateString(date){
                //const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(date.getDate()).padStart(2, '0');
                
                var formatteDate = `${year}-${month}-${day}`;
                return formatteDate;

                console.log(`${year}-${month}-${day}`); // YYYY-MM-DD
                console.log(`${day}/${month}/${year}`); // DD/MM/YYYY
                console.log(`${month}-${day}-${year}`); // MM-DD-YYYY
            }
            function getRandomHexColor() {
            const randomColor = Math.floor(Math.random() * 16777215).toString(16);
            return `#${randomColor.padStart(6, '0')}`;
            }

            function listExceptionType(exceptionType){
                // if (_exceptionTypes.includes(exceptionType)){
                //     return;
                // }
                var items = document.getElementById('selExceptionTypes');
                var item = document.createElement('option');
                item.value = exceptionType;
                item.innerHTML = exceptionType;
                items.appendChild(item);
                //_exceptionTypes.push(exceptionType);
            }
            function csvToDatasetOfExcetpions(csvData,locid,exceptionTypes,fdate='',tdate=''){                
                var t_exectpionType = '';
                var dateSeries = [];
                var m_measureDataset = [];
                var measureDataset = {
                        label:"Measurement",
                        data: [], borderWidth:1,borderColor:'#00ff00'
                    };
                var degradedDataset = {
                        label:"Degraded",
                        data: [], borderWidth:1,borderColor:'#ff0000'
                    };
                var threatenedDataset = {
                    label:"Threatened",
                    data: [], borderWidth:1,borderColor:'#ffff00'
                };

                for (var i in csvData){                    
                    var each = csvData[i];
                    if (each.Measurement == 0){
                        continue;
                    }
                    if (locid && each.LOC_ID != locid){
                        continue;
                    }
                    if (exceptionTypes && !exceptionTypes.includes(each.Title)){
                        continue;
                    }
                    
                    

                    const measuredDate = new Date(each.Date);
                    if (fdate =='' && tdate ==''){
                        var tempDate = new Date();
                        tempDate = measuredDate;
                        fdate =  getDateString(tempDate);
                        document.getElementById('fDateSelected').value = fdate;
                        tempDate.setMonth(tempDate.getMonth()+ 3);
                        tdate = getDateString(tempDate);

                        document.getElementById('tDateSelected').value = tdate;
                        
                    }
                    if (fdate !='' && tdate !=''){
                        var fromDate = new Date(fdate);
                        var toDate = new Date(tdate);
                        if (!(measuredDate >= fromDate && measuredDate <= toDate)){
                            continue;
                        }
                    }
                    if (t_exectpionType != each.Title){
                        if (measureDataset.data.length > 0){
                            m_measureDataset.push(measureDataset);
                        }
                        
                        t_exectpionType = each.Title;
                        measureDataset.data =[]; 
                        measureDataset.label = each.Title;          
                        measureDataset.borderColor = getRandomHexColor();
                    }                    
                    
                    var measureValue = each.Measurement;
                    if (each.Title == 'Event Time'){
                         var timeString = each.Measurement;
                         var dateString = "23-DEC-2024";
                         var date =  (timeString, "HH:mm:ss", new Date());
                         measureDataset.data.push(Date.parse(dateString + " " + timeString));
                         //measureDataset.data.push(each.Measurement);

                         timeString = each.Yellow;
                         date =  (timeString, "HH:mm:ss", new Date());
                         threatenedDataset.data.push(Date.parse(dateString + " " + timeString));
                         //threatenedDataset.data.push(each.Yellow);

                         timeString = each.Red;
                         date =  (timeString, "HH:mm:ss", new Date());
                         degradedDataset.data.push(Date.parse(dateString + " " + timeString));
                         //degradedDataset.data.push(each.Red);


                    }
                    else {
                        measureDataset.label = each.Title;
                        measureDataset.data.push(measureValue);
                        degradedDataset.data.push(each.Red);
                        threatenedDataset.data.push(each.Yellow);
                    }
                    
                    
                   // const utcDate = new Date(each.Date); // UTC time
                   // const localDate = new Date(utcDate.toDateString); // Converts to local time
                    dateSeries.push(each.Date);
                   
                }
                if (m_measureDataset.length==0){
                    m_measureDataset.push(measureDataset);
                }
                
                var chartDataset ={
                    dateSeries: dateSeries,
                    dataSet:m_measureDataset.concat([degradedDataset,threatenedDataset]),
                    exceptionType:'..'
                }
                return chartDataset;
            }
            function csvToDatasetByException(csvData,locid,exceptionType,fdate='',tdate=''){
                var t_exectpionType = '';
                var t_itemType = '';
                var dateSeries = [];
                var measuredValueColour = getRandomHexColor()
                var measureDataset = {
                        label: exceptionType,
                        data: [
                            // { x: 0, y: 0 },
                            // { x: 1, y: 1.5 },
                            // { x: 2, y: 2.5 },
                            // { x: 3, y: 13 },
                            // { x: 4, y: 40 },
                        ],
                        borderColor: measuredValueColour,
                        backgroundColor: measuredValueColour,
                        showLine: true, // Connect points with a line
                    };
                var degradedDataset = {
                        label:"Degraded",
                        data: [],  borderColor: 'rgba(255, 0, 0, 1)',
                        backgroundColor:  'rgba(255, 0, 0, 1)',
                        showLine: true, // Connect points with a line
                    };
                var threatenedDataset = {
                    label:"Threatened",
                    data: [], borderColor: 'rgba(255, 255, 0, 1)',
                        backgroundColor:  'rgba(255, 255, 0, 1)',
                        showLine: true, // Connect points with a line
                };

                for (var i in csvData){

                    var each = csvData[i];
                    if (each.Measurement == 0){
                        continue;
                    }
                    if (locid && each.LOC_ID != locid){
                        continue;
                    }
                    if (exceptionType && each.Title != exceptionType){
                        continue;
                    }
                    const measuredDate = new Date(each.Date);
                    if (fdate =='' && tdate ==''){
                        var tempDate = new Date();
                        tempDate = measuredDate;
                        fdate =  getDateString(tempDate);
                        //initSlider(fdate,fdate);
                        document.getElementById('fDateSelected').value = fdate;
                        tempDate.setMonth(tempDate.getMonth()+ 3);
                        tdate = getDateString(tempDate);

                        document.getElementById('tDateSelected').value = tdate;
                        
                    }
                    if (fdate !='' && tdate !=''){
                        var fromDate = new Date(fdate);
                        var toDate = new Date(tdate);
                        document.getElementById('fDateSelected').value = fdate;
                        document.getElementById('tDateSelected').value = tdate;
                        initSlider(fdate,tdate);
                        if (!(measuredDate >= fromDate && measuredDate <= toDate)){
                            continue;
                        }
                    }
                    var measureValue = each.Measurement;
                    if (exceptionType == 'Event Time'){
                         var timeString = each.Measurement;
                         var dateString = "01-JAN-2000";
                         var date =  (timeString, "HH:mm:ss", new Date());
                         //Date.parse(dateString + " " + timeString)}
                         measureDataset.data.push({x: new Date(each.Date),y: Date.parse(dateString + " " + timeString)});
                         //measureDataset.data.push(each.Measurement);

                         timeString = each.Yellow;
                         date =  (timeString, "HH:mm:ss", new Date());
                         threatenedDataset.data.push({x: new Date(each.Date),y: Date.parse(dateString + " " + timeString)});
                         //threatenedDataset.data.push(each.Yellow);

                         timeString = each.Red;
                         date =  (timeString, "HH:mm:ss", new Date());
                         degradedDataset.data.push({x: new Date(each.Date),y: Date.parse(dateString + " " + timeString)});
                         //degradedDataset.data.push(each.Red);


                    }
                    else {
                        // measureDataset.data.push(measureValue);
                        // degradedDataset.data.push(each.Red);
                        // threatenedDataset.data.push(each.Yellow);
                        measureDataset.data.push({x:new Date(each.Date),y:measureValue});
                        degradedDataset.data.push({x:new Date(each.Date),y:each.Red});
                        threatenedDataset.data.push({x:new Date(each.Date),y:each.Yellow});
                    }
                    if (measureDataset.data.length>10000){
                        tdate = getDateString(new Date(each.Date));
                        document.getElementById('tDateSelected').value = tdate;
                        break;
                       
                    }
                    
                   // const utcDate = new Date(each.Date); // UTC time
                   // const localDate = new Date(utcDate.toDateString); // Converts to local time
                   
                    //dateSeries.push(each.Date);
                   
                }
                var chartDataset ={
                    dateSeries: dateSeries,
                    dataSet:[measureDataset,degradedDataset,threatenedDataset],
                    exceptionType:exceptionType
                }
                return chartDataset;
            }
            function readAllExceptionTypes(csvData,locid){
                let counter=0;
                var t_exectpionType = '';
                for (var i in csvData){
                    var each = csvData[i];
                    if (each.Measurement == 0){
                        continue;
                    }
                    if (locid && each.LOC_ID != locid){
                        continue;
                    }
                    if (t_exectpionType != each.Title){
                        t_exectpionType = each.Title;    
                        listExceptionType(each.Title);
                        if (counter == 0){
                            _exceptionTypes.push(each.Title);
                        }
                        counter++;
                    }
                }
            }
            function csvToDataset(csvData,locid,fdate='',tdate=''){
                var t_exectpionType = '';
                var dateSeries = [];
                let counter = 0;
                var measureDataset = {
                        label:"Measurement",
                        data: [], borderWidth:1,borderColor:'#00ff00'
                    };
                var degradedDataset = {
                        label:"Degraded",
                        data: [], borderWidth:1,borderColor:'#ff0000'
                    };
                var threatenedDataset = {
                    label:"Threatened",
                    data: [], borderWidth:1,borderColor:'#ffff00'
                };
              
                for (var i in csvData){

                    var each = csvData[i];
                    if (each.Measurement == 0){
                        continue;
                    }
                    if (locid && each.LOC_ID != locid){
                        continue;
                    }
                    // if (exceptionType && each.Title != exceptionType){
                    //     continue;
                    // }
                    const measuredDate = new Date(each.Date);
                    
                    // if (!t_exectpionType){
                    //     t_exectpionType = each.Title;
                    //     addExceptionType(each.Title);
                    // }
                    
                    if (t_exectpionType != each.Title){
                        t_exectpionType = each.Title;
                        
                        listExceptionType(each.Title);
                        counter++;                        
                        
                        if (each.Title == 'Event Time'){
                            continue;
                        }
                        if (counter>1){
                            continue;
                        }
                        measureDataset.label = each.Title
                        
                    }
                    if (fdate =='' && tdate ==''){
                        var tempDate = new Date();
                        tempDate = measuredDate;
                        fdate =  getDateString(tempDate);
                        document.getElementById('fDateSelected').value = fdate;
                        tempDate.setMonth(tempDate.getMonth()+ 3);
                        tdate = getDateString(tempDate);
                        document.getElementById('tDateSelected').value = tdate;
                        
                    }
                    if (fdate !='' && tdate !=''){
                        var fromDate = new Date(fdate);
                        var toDate = new Date(tdate);
                        if (!(measuredDate >= fromDate && measuredDate <= toDate)){
                            continue;
                        }
                    }
                    var measureValue = each.Measurement;
                    if (t_exectpionType == 'Event Time'){
                         var timeString = each.Measurement;
                         var dateString = "23-DEC-2024";
                         var date =  (timeString, "HH:mm:ss", new Date());
                         measureDataset.data.push(Date.parse(dateString + " " + timeString));
                         //measureDataset.data.push(each.Measurement);

                         timeString = each.Yellow;
                         date =  (timeString, "HH:mm:ss", new Date());
                         threatenedDataset.data.push(Date.parse(dateString + " " + timeString));
                         //threatenedDataset.data.push(each.Yellow);

                         timeString = each.Red;
                         date =  (timeString, "HH:mm:ss", new Date());
                         degradedDataset.data.push(Date.parse(dateString + " " + timeString));
                         //degradedDataset.data.push(each.Red);


                    }
                    else {
                        measureDataset.data.push(measureValue);
                        degradedDataset.data.push(each.Red);
                        threatenedDataset.data.push(each.Yellow);
                    }
                    
                    
                   // const utcDate = new Date(each.Date); // UTC time
                   // const localDate = new Date(utcDate.toDateString); // Converts to local time
                    dateSeries.push(each.Date);
                    if (dateSeries.length > 10000){
                        break;
                    }
                   
                }
                var chartDataset ={
                    dateSeries: dateSeries,
                    dataSet:[measureDataset,degradedDataset,threatenedDataset],
                    exceptionType:measureDataset.label
                }
                return chartDataset;
            }
            function isDateWithinRange(in_date){
                let fDate = '01-JAN-1999'
                let tDate = '01-JAN-2001';
                fDate = Date.parse(fDate);
                tDate = Date.parse(tDate);
                if (in_date >= fDate && in_date <= tDate){
                    return true;
                }
                return false;
        
            }
            function featuresToDataSet(features){
                
                var dateSeries = [];
                var measureDataset = {
                        label:"Measurement",
                        data: [], borderWidth:1,borderColor:'#00ff00'
                    };
                var degradedDataset = {
                        label:"Degraded",
                        data: [], borderWidth:1,borderColor:'#ff0000'
                    };
                var threatenedDataset = {
                    label:"",
                    data: [], borderWidth:1,borderColor:'#ffff00'
                };
                for (var i in features){

                    var each = features[i];
                    if (each.attributes.Measurement == 0){
                        continue;
                    }
                    measureDataset.data.push(each.attributes.Measurement);
                    degradedDataset.data.push(each.attributes.Red);
                    threatenedDataset.data.push(each.attributes.Yellow);
                    const utcDate = new Date(each.attributes.Date); // UTC time
                    const localDate = new Date(utcDate.toDateString); // Converts to local time
                    dateSeries.push(utcDate.toDateString());
                   
                }
                var chartDataset ={
                    dateSeries: dateSeries,
                    dataSet:[measureDataset,degradedDataset,threatenedDataset]
                }
                return chartDataset;
            }
            function epoch_to_hh_mm_ss(epoch) {
                return new Date(epoch*1000).toISOString().substr(12, 7)
            }
            function InitChart(chartCtrl,chartType,labels, datasets,title){
                if (_chart) {
                    _chart.destroy();
                    }
                    _chart = new Chart(chartCtrl, {
                        type: chartType,
                        data: {
                        labels: labels,
                        datasets:datasets
                        },
                        options: {
                            plugins: {
                                title: {
                                    display: true, // Enable the title
                                    text: title, // The title text
                                    font: {
                                    size: 18, // Font size
                                    weight: 'bold' // Font weight
                                    },
                                    padding: {
                                    top: 10,
                                    bottom: 20
                                    },
                                    color: 'rgb(75, 192, 192)' // Text color
                                },
                                legend: {
                                labels: {
                                    color: 'rgb(75, 192, 192)', // Label text color
                                    font: {
                                    size: 18, // Font size
                                    family: 'Arial', // Font family
                                    },
                                    boxWidth: 20, // Width of the color box
                                    boxHeight: 10, // Height of the color box
                                    padding: 10, // Padding between legend items
                                    usePointStyle: true, // Use point style (e.g., circles)
                                },
                                },
                                // tooltip: {
                                //     callbacks: {
                                //     label: function(context) {
                                //         console.log(context);
                                //         var e = context.raw;
                                //     // e= e.replaceAll(",","");
                                //     var timeString = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                //     var label = "Measurement:"+ timeString
                                //         return label;
                                //     //  return new Date(context.formattedvalue).toTimeString();
                                //     }
                                //     }
                                // }
                            },
                           
                            scales: {
                            y:{
                                title:{
                                    display: true,
                                    text: 'Measurement',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14
                                    }
                                }
                            },
                            x:{
                                title:{
                                    display: true,
                                    text: 'Date',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14
                                    }
                                }
                            } 
                            
                            }
                        }
                    });
            }
            function InitScatterChart(chartCtrl,chartType,labels, datasets,title){
                if (_chart) {
                    _chart.destroy();
                    }
                    _chart = new Chart(chartCtrl, {
                        type: chartType,
                        data: {
                        datasets:datasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                zoom: {
                                    pan: {
                                        enabled: true,
                                        mode: 'x',  // Allow panning in the x-axis
                                    },
                                    zoom: {
                                        wheel: {
                                        enabled: true, // Enable zooming with mouse wheel
                                        },
                                        pinch: {
                                        enabled: true // Enable zooming with pinch gestures
                                        },
                                        mode: 'x',  // Allow zooming in the x-axis
                                    }
                                },
                                legend: {
                                labels: {
                                    color: 'Green', // Label text color
                                    font: {
                                        size: 18, // Font size
                                        family: 'Arial', // Font family
                                    },
                                    boxWidth: 20, // Width of the color box
                                    boxHeight: 10, // Height of the color box
                                    padding: 10, // Padding between legend items
                                    usePointStyle: true, // Use point style (e.g., circles)
                                },
                                },
                                title: {
                                    display: true, // Enable the title
                                    text: title, // The title text
                                    font: {
                                            size: 18, // Font size
                                            weight: 'bold' // Font weight
                                    },
                                    padding: {
                                    top: 10,
                                    bottom: 20
                                    },
                                    color: 'rgb(75, 192, 192)' // Text color
                                },
                                tooltip: {
                                    callbacks: {
                                    label: function(context) {
                                       // console.log(context);
                                         var e = context.raw.x; //Date time
                                         var y = context.raw.y; //measure value
                                    // // e= e.replaceAll(",","");
                                    var time = String(new Date(e).getHours()).padStart(2,'0') + ":"+ String(new Date(e).getMinutes()).padStart(2,'0') + ":"+String(new Date(e).getSeconds()).padStart(2,'0');
                                    var eventTime =  new Date(e).toDateString() + ' ' + time ;
                                    if(isDateWithinRange(y)){
                                        y = new Date(y).getHours() + ":"+ new Date(y).getMinutes() + ":"+new Date(y).getSeconds();
                                    }

                                     
                                     var label = "Measurement:"+ y
                                     label = label + ' at ' + eventTime;
                                         return label;
                                    //  return new Date(context.formattedvalue).toTimeString();
                                    }
                                    }
                                }
                            },
                           
                            scales: {
                            y:{
                                title:{
                                    display: true,
                                    text: 'Measurement',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14
                                    },
                                    callback:(e,index,ticks)=>{
                                        //console.log(ticks);
                                       // console.log(e);
                                        if (isDateWithinRange(e)){
                                            var time = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                            return time;
                                        }
                                        // if (e instanceof Date) {
                                        //     console.log("It's a Date object!");
                                        // } else {
                                        //     console.log("It's not a Date object.");
                                        // }
                                        return e;
                                    }
                                }
                            },
                            x:{
                                type: 'time',
                                title:{
                                    display: true,
                                    text: 'Date',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14
                                    },
                                    callback:function(e){
                                            //console.log('ticks:' + e)
                                            var time = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                            return  new Date(e).toDateString() + ' ' + time ;
                                        },
                                }
                            } 
                            
                            }
                        }
                    });
            }
            function InitChartEventType(chartCtrl,chartType,labels, datasets,title){
                if (_chart){
                    _chart.destroy();
                }
                _chart = new Chart(chartCtrl, {
                        type: chartType,
                        data: {
                        labels: labels,
                        datasets:datasets
                        },
                        options: {
                            plugins: {
                                title: {
                                    display: true, // Enable the title
                                    text: title, // The title text
                                    font: {
                                    size: 18, // Font size
                                    weight: 'bold' // Font weight
                                    },
                                    padding: {
                                    top: 10,
                                    bottom: 20
                                    },
                                    color: 'rgb(75, 192, 192)' // Text color
                            },
                            tooltip: {
                                callbacks: {
                                label: function(context) {
                                    console.log(context);
                                    var e = context.raw;
                                   // e= e.replaceAll(",","");
                                   var timeString = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                   var label = "Measurement:"+ timeString
                                    return label;
                                  //  return new Date(context.formattedvalue).toTimeString();
                                }
                                }
                            }
                            },
                           
                            scales: {
                                x:{
                                title:{
                                    display: true,
                                    text: 'Date',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14,
                                    
                                    }
                                }
                            } ,
                                y:{
                                    ticks:{
                                        callback:function(e){
                                            //console.log('ticks:' + e)
                                            return  new Date(e).getHours() + ":"+ new Date(e).getMinutes() ;
                                        },
                                        color: 'green',
                                        font: {
                                        size: 14
                                        }

                                    },
                                    title:{
                                        display: true,
                                        text: 'Measurement',
                                        color: 'green',
                                        font: {
                                        size: 16,
                                        weight: 'bold',
                                        family: 'Verdana'
                                        }
                                    }
                                    
                                } 
                            
                            }
                        }
                    });
            }
            function readSelectedItems() {
                _exceptionTypes= [];
                const select = document.getElementById('selExceptionTypes');
                const selectedValues = Array.from(select.options)
                                            .filter(option => option.selected)
                                            .map(option => option.value);
                selectedValues.forEach((item,i,selectedValues)=>{
                    if (!_exceptionTypes.includes(item)){
                        _exceptionTypes.push(item);
                    }
                })
                console.log("Selected items:", selectedValues);
            }
            function mergeDataSets(baseChartDataset,newChartDataset=null){
                let yId = baseChartDataset.dataSet.length;
                if (!newChartDataset){
                    baseChartDataset.dataSet[yId-1].yAxisID = 'y' + yId;
                    return baseChartDataset;
                }
                var newMeasuredDataset = newChartDataset.dataSet[0];
                var newDegradedDataset = newChartDataset.dataSet[1];
                var newThreatenedDataset = newChartDataset.dataSet[2];
                var newDateSeries =  newChartDataset.dateSeries;

                baseChartDataset.dateSeries = baseChartDataset.dateSeries.concat(newDateSeries);
                baseChartDataset.dataSet[1].data = baseChartDataset.dataSet[1].data.concat(newDegradedDataset.data);
                baseChartDataset.dataSet[2].data = baseChartDataset.dataSet[2].data.concat(newThreatenedDataset.data);

                
                newMeasuredDataset.yAxisID = 'y' + yId;
                baseChartDataset.dataSet = baseChartDataset.dataSet.concat(newMeasuredDataset);
                return baseChartDataset;

            }
            function getSliderRange() {
                var slider = document.getElementById("slider");
                var daterange ={
                    fdate:null,tdate:null
                }

                if (slider.noUiSlider) {
                    daterange.fdate = slider.noUiSlider.options.range.min;
                    daterange.tdate = slider.noUiSlider.options.range.max;
                  //  console.log("Current Min:", min, "Current Max:", max);
                    return daterange;
                } else {
                    console.warn("Slider is not initialized yet.");
                    return null;
                }
            }
            
            function selectedLoad(fDate,tDate){
                readSelectedItems();
                var fromDate;
                var toDate
                if (!fDate && !tDate ){
                    fromDate = document.getElementById('fDateSelected').value;
                    toDate = document.getElementById('tDateSelected').value;
                }
                else{
                     fromDate = fDate;
                     toDate = tDate;
                }
               
                
                if (_exceptionTypes && _exceptionTypes.length > 0){
                    var dateRange = getSliderRange();
                    
                    _exceptionTypes.forEach((exceptionType,i,_exceptionTypes)=>{
                        chartDataSet = csvToDatasetByException(_trendlineData,_locid,exceptionType,fromDate,toDate);
                        if (i==0){
                            chartDataSet.dataSet[0].backgroundColor = '#00ff00';
                            chartDataSet.dataSet[0].borderColor = '#00ff00';
                            _chartDataset =  mergeDataSets(chartDataSet);
                        }
                        else{
                            _chartDataset =  mergeDataSets(_chartDataset,chartDataSet);
                        }
                    });
                    const ctx = document.getElementById('myChart');
                    InitScatterChart(ctx,'scatter',_chartDataset.dateSeries.sort((a, b) => a - b),_chartDataset.dataSet,_exceptionTypes.join(','));
                }
            }
            function onLoad(trendlineData){
                if (!trendlineData && _trendlineData){
                    trendlineData = _trendlineData;
                }
                readSelectedItems();
                const params = new URLSearchParams(window.location.search);
                _locid = params.get('locid')?params.get('locid'):'';                
                var fromDate = document.getElementById('fDateSelected').value;
                var toDate = document.getElementById('tDateSelected').value;
                //var exceptionType = document.getElementById('selExceptionTypes').value;

                // if (!exceptionType)
                //     {
                //     alert('No Exception type');
                //     return;   
                //     }
                //var chartDataSet = featuresToDataSet(trendlineData.features);
                var chartDataset = {
                    exceptionType:'',
                    dataSet:[],
                    dateSeries:[]
                };
                const ctx = document.getElementById('myChart');
                // if (_exceptionTypes.length> 0){
                //     const chartDataSet = csvToDatasetOfExcetpions(trendlineData,locid,_exceptionTypes,fromDate,toDate);
                //     InitChart(ctx,'line',chartDataSet.dateSeries,chartDataSet.dataSet,chartDataset.exceptionType);
                //     return;
                // } 
                // else{
                //     chartDataSet = csvToDataset(trendlineData,locid,fromDate,toDate);
                //     chartDataSet = csvToDatasetByException(trendlineData,locid,chartDataSet.exceptionType,fromDate,toDate);
                // }
                
                console.log(new Date(Date.now()).toTimeString())
                console.log('Data Loaded');
                readAllExceptionTypes(trendlineData,_locid);
                chartDataSet = csvToDatasetByException(_trendlineData,_locid,_exceptionTypes[0],fromDate,toDate);
                
                //chartDataSet = csvToDataset(trendlineData,_locid,fromDate,toDate);
                console.log(new Date(Date.now()).toTimeString())
                console.log('Data Selected');
                // chartDataSet = csvToDatasetByException(trendlineData,locid,chartDataSet.exceptionType,fromDate,toDate);
                // if (!exceptionType){
                //     exceptionType = chartDataSet.exceptionType;
                // }
              
                

                // if (chartDataSet.exceptionType == 'Event Time'){
                //     InitChartEventType(ctx,'line',chartDataSet.dateSeries,chartDataSet.dataSet,chartDataSet.exceptionType);
               
                // }
                // else{
                //     InitChart(ctx,'line',chartDataSet.dateSeries,chartDataSet.dataSet,chartDataSet.exceptionType);
                // }
                InitScatterChart(ctx,'scatter',chartDataSet.dateSeries.sort((a, b) => a - b),chartDataSet.dataSet,_exceptionTypes.join(','));
                console.log(new Date(Date.now()).toTimeString())
                console.log('Data Plotted');
            }
            function initSlider(fDate,tDate){
                const slider = document.getElementById("slider");
                const sliderValue = document.getElementById("slider-value");
                
                const startDate = new Date(fDate).getTime();
                const endDate = new Date(tDate).getTime();
                // const startDate = new Date("2024-01-01T00:00:00").getTime();
                // const endDate = new Date("2024-12-31T23:59:59").getTime();
                
                function formatDateTime(timestamp) {
                    const date = new Date(Number(timestamp));
                    if (isNaN(date.getTime())) return "Invalid Date";
                    
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    
                    return `${year}-${month}-${day} ${hours}:${minutes}`;
                }
                if (slider.noUiSlider) {
                    slider.noUiSlider.updateOptions({
                        connect: true,
                        // range: {
                        //     min: startDate,
                        //     max: endDate
                        // },
                        start: [startDate,endDate] // Set to new start value
                    });
                    return;
                }
                
                noUiSlider.create(slider, {
                    start: [startDate,endDate],
                    connect: true,
                    range: {
                        'min': startDate,
                        'max': endDate
                    },
                    step: 3600, // One hour in milliseconds
                    // format: {
                    //     to: formatDateTime,
                       
                    //     from: value => {
                    //         const timestamp = Date.parse(value);
                    //         return isNaN(timestamp) ? startDate : timestamp;
                    //     }
                    // }
                });
                
                slider.noUiSlider.on("update", (values) => {
                    var from = formatDateTime(values[0]);
                    var to = formatDateTime(values[1]);
                   /// selectedLoad(values[0],values[1]);
                   _currentDateRange.fDate =from;
                   _currentDateRange.tDate = to;
                   slidervalue1.textContent = from;
                   slidervalue2.textContent = to;
                   // sliderValue.textContent = `Range: ${from} - ${to}`;
                });
            }
            
          </script>
          <style>
            .slider-container {
                width: 100%;               /* Adjust the width as needed */
                margin: 50px auto;          /* Center the container horizontally */
                }

                #slider {
                width: 100%;                /* Full width of the container */
                height: 10px;                /* Adjust the slider height */
                background: #ddd;           /* Placeholder background */
                position: relative;
                margin-bottom: 10px; 
                  /* Space between slider and values */
                }

                .slider-values {
                    display: flex;
                    justify-content: space-between;  /* Align values to left and right edges */
                    margin-top: 25px;                /* Move the values slightly down */
                    }

                    .slider-value1, .slider-value2 {
                    font-size: 14px;
                    color: green;
                    }

          </style>
          
          <style>
            body {
                background-color: black;
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            /* .slider-container {
                width: 90%;
                
                
                margin: 20px auto;
                color: wheat;
                border-color: red;
                z-index: 99;
            } */
            /* .slider-value1{
                display: flex; justify-content: flex-start;
            }
            .slider-value1{
                display: flex; justify-content: flex-end;
            } */
            #divChart {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: center;
                width: 90%;
                max-width: 1200px;
                margin: auto;
            }

            canvas {
                width: 100% !important;
                max-width: 800px;
                height: auto !important;
            }

            #divExcetpionList {
                margin-top: 20px;
                width: 100%;
                max-width: 400px;
                text-align: center;
            }

            #divDateControls {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }

            select {
                width: 100%;
                height: 120px;
            }
        </style>
    </head>
    <body onload="readTrendlineData()">
        
        <div id="divChart">   
                 
            <div>
                <div class="slider-container">
                    <!-- Slider -->
                    <div id="slider"></div>
                  
                    <!-- Values aligned to the edges -->
                    <div class="slider-values">
                      <div class="slider-value1" id="slidervalue1">Start: 0</div>
                      <div class="slider-value2" id="slidervalue2">End: 100</div>
                    </div>
                  </div>
                   
                <canvas id="myChart" ></canvas>
            </div>
            <div id="divExcetpionList">
                <div id="divDateControls">
                    <label for="fDateSelected">From:</label>
                    <input type="date" id="fDateSelected" placeholder="YYYY-MM-DD">
                    <label for="tDateSelected">To:</label>
                    <input type="date" id="tDateSelected" placeholder="YYYY-MM-DD">
                    <button onclick="onDateChange()">Refresh</button>
                </div>
                <select id="selExceptionTypes" onchange="selectedLoad()"  size="5" multiple>
                    <!-- Options will be dynamically populated -->
                </select>
            </div>
        </div>   

    </body>
  
      
</html>
