<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Trendline</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.3.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
        <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
        <script>
            var _trendlineData = null;
            var _chart = null;
            var _exceptionTypes =[];
            var _locid ='';
            var _chartDataset = {
                    exceptionType:'',
                    dataSet:[],
                    dateSeries:[]
                };
            var _currentDateRange ={
                fDate:null,tDate:null
            }
            var _dataDateRange = {
                fDate:null,tDate:null
            };
            function readTrendlineData(){  
                
               // var url = "https://services3.arcgis.com/5IIttubzVsJ0uEuF/ArcGIS/rest/services/trendlines_dev_2024_1_1/FeatureServer/0/query?where=Title='Motor RPM'&objectIds=&resultType=none&outFields=*&returnIdsOnly=false&returnUniqueIdsOnly=false&returnCountOnly=false&returnDistinctValues=true&cacheHint=false&collation=&orderByFields=Date&groupByFieldsForStatistics=&outStatistics=&having=&resultOffset=&resultRecordCount=&sqlFormat=none&f=pjson&token=";
               var url = 'trendlines_dev_2024_1.csv';
                var xhttp = new XMLHttpRequest();
                xhttp.open('GET',url,true);
                xhttp.onload = function() {
                   // var geoData = JSON.parse(this.responseText);
                    //alert(geoData.features[0].properties['ID'])
                    
                    //onLoad(geoData);
                    parseCSV(this.responseText);
                    //displayJSONAsTable(geoData.features[0].properties);
                }
                xhttp.send();
            }
            function parseCSV(csvData){
                Papa.parse(csvData, {
                        header: true, // Set to false if no headers in the CSV
                        skipEmptyLines: true,
                        complete: function (results) {
                            console.log(results.data); // Parsed data
                            _trendlineData = results.data;
                            onLoad();
                            //document.getElementById("output").textContent = JSON.stringify(results.data, null, 2);
                        },
                        error: function (error) {
                            console.error("Error parsing CSV:", error);
                        }
                    });
            }
            function onDateChange(){
                console.log(new Date(Date.now()).toTimeString())
                console.log('Selected Exception');
                selectedLoad(_currentDateRange.fDate,_currentDateRange.tDate);
            }
            function getDateString(date){
                //const date = new Date();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const day = String(date.getDate()).padStart(2, '0');
                
                var formatteDate = `${year}-${month}-${day}`;
                return formatteDate;

                console.log(`${year}-${month}-${day}`); // YYYY-MM-DD
                console.log(`${day}/${month}/${year}`); // DD/MM/YYYY
                console.log(`${month}-${day}-${year}`); // MM-DD-YYYY
            }
            function getRandomHexColor() {
            const randomColor = Math.floor(Math.random() * 16777215).toString(16);
            return `#${randomColor.padStart(6, '0')}`;
            }

            function listExceptionType(exceptionType){
                // if (_exceptionTypes.includes(exceptionType)){
                //     return;
                // }
                var items = document.getElementById('selExceptionTypes');
                var item = document.createElement('option');
                item.value = exceptionType;
                item.innerHTML = exceptionType;
                items.appendChild(item);
                //_exceptionTypes.push(exceptionType);
            }
            
            function csvToDatasetByException(csvData,locid,exceptionType,fdate='',tdate=''){
                let dataLimit = document.getElementById('selDataLimit').value;
                if (!dataLimit){
                    dataLimit = 100;
                }
                var t_exectpionType = '';
                var t_itemType = '';
                var dateSeries = [];
                var max_tDate = '';
                var measuredValueColour = getRandomHexColor()
                var measureDataset = {
                        label: exceptionType,
                        data: [
                            // { x: 0, y: 0 },
                            // { x: 1, y: 1.5 },
                            // { x: 2, y: 2.5 },
                            // { x: 3, y: 13 },
                            // { x: 4, y: 40 },
                        ],
                        borderColor: measuredValueColour,
                        backgroundColor: measuredValueColour,
                        showLine: true, // Connect points with a line
                        scales:[]
                    };
                var degradedDataset = {
                        label:"Degraded",
                        data: [],  borderColor: 'rgba(255, 0, 0, 1)',
                        backgroundColor:  'rgba(255, 0, 0, 1)',
                        showLine: true, // Connect points with a line
                    };
                var threatenedDataset = {
                    label:"Threatened",
                    data: [], borderColor: 'rgba(255, 255, 0, 1)',
                        backgroundColor:  'rgba(255, 255, 0, 1)',
                        showLine: true, // Connect points with a line
                };

                for (var i in csvData){

                    var each = csvData[i];
                    if (each.Measurement == 0){
                        continue;
                    }
                    if (locid && each.LOC_ID != locid){
                        continue;
                    }
                    if (exceptionType && each.Title != exceptionType){
                        continue;
                    }
                    const measuredDate = new Date(each.Date);
                    if (fdate =='' && tdate ==''){
                        var tempDate = new Date();
                        tempDate = measuredDate;
                        fdate =  getDateString(tempDate);
                        //initSlider(fdate,fdate);
                        //document.getElementById('fDateSelected').value = fdate;
                        tempDate.setMonth(tempDate.getMonth()+ 3);
                        tdate = getDateString(tempDate);

                       // document.getElementById('tDateSelected').value = tdate;
                        
                    }
                    if (fdate !='' && tdate !=''){
                        var fromDate = new Date(fdate);
                        var toDate = new Date(tdate);
                        //document.getElementById('fDateSelected').value = fdate;
                       // document.getElementById('tDateSelected').value = tdate;
                        initSlider(fdate,tdate);
                        if (max_tDate){
                            if (!(measuredDate >= fromDate && measuredDate <= max_tDate)){
                                continue;
                            }
                        }
                        else if (!(measuredDate >= fromDate && measuredDate <= toDate)){
                            continue;
                        }
                    }
                    var measureValue = each.Measurement;
                    if (exceptionType == 'Event Time'){
                         var timeString = each.Measurement;
                         var dateString = "01-JAN-2000";
                         var date =  (timeString, "HH:mm:ss", new Date());
                         //Date.parse(dateString + " " + timeString)}
                         measureDataset.data.push({x: new Date(each.Date),y: Date.parse(dateString + " " + timeString)});
                         //measureDataset.data.push(each.Measurement);

                         timeString = each.Yellow;
                         date =  (timeString, "HH:mm:ss", new Date());
                         threatenedDataset.data.push({x: new Date(each.Date),y: Date.parse(dateString + " " + timeString)});
                         //threatenedDataset.data.push(each.Yellow);

                         timeString = each.Red;
                         date =  (timeString, "HH:mm:ss", new Date());
                         degradedDataset.data.push({x: new Date(each.Date),y: Date.parse(dateString + " " + timeString)});
                         //degradedDataset.data.push(each.Red);


                    }
                    else {
                        // measureDataset.data.push(measureValue);
                        // degradedDataset.data.push(each.Red);
                        // threatenedDataset.data.push(each.Yellow);
                        measureDataset.data.push({x:new Date(each.Date),y:measureValue});
                        degradedDataset.data.push({x:new Date(each.Date),y:each.Red});
                        threatenedDataset.data.push({x:new Date(each.Date),y:each.Yellow});
                    }
                    
                    if (!max_tDate && measureDataset.data.length>dataLimit){
                        tdate = getDateString(new Date(each.Date));
                        max_tDate = new Date(tdate);
                        initSlider(fdate,tdate);
                        //document.getElementById('tDateSelected').value = tdate;
                        //break;
                       
                    }
                    
                   // const utcDate = new Date(each.Date); // UTC time
                   // const localDate = new Date(utcDate.toDateString); // Converts to local time
                   
                    //dateSeries.push(each.Date);
                   
                }

                var chartDataset ={
                    dateSeries: dateSeries,
                    dataSet:[measureDataset],
                    //dataSet:[measureDataset,degradedDataset,threatenedDataset],
                    exceptionType:exceptionType
                }
                return chartDataset;
            }
            
            function readAllExceptionTypes(csvData,locid){
                let counter=0;
                var t_exectpionType = '';
                var t_dateRange = {
                    fDate:null, tDate:null
                }
                for (var i in csvData){
                    var each = csvData[i];
                    
                    if (each.Measurement == 0){
                        continue;
                    }
                    if (locid && each.LOC_ID != locid){
                        continue;
                    }
                    if (!t_dateRange.fDate){
                        t_dateRange.fDate = each.Date;
                        t_dateRange.tDate = each.Date;
                    }
                    else{
                        if (new Date(each.Date) < new Date(t_dateRange.fDate) ){
                            t_dateRange.fDate = each.Date;
                        }
                        if (new Date(each.Date) > new Date(t_dateRange.tDate) ){
                            t_dateRange.tDate = each.Date;
                        }
                    }
                    
                    if (t_exectpionType != each.Title){
                        t_exectpionType = each.Title;    
                        listExceptionType(each.Title);
                        if (counter == 0){
                            _exceptionTypes.push(each.Title);
                        }
                        counter++;
                    }
                }
                _dataDateRange = t_dateRange;
            }
           
            function isDateWithinRange(in_date){
                let fDate = '01-JAN-1999'
                let tDate = '01-JAN-2001';
                fDate = Date.parse(fDate);
                tDate = Date.parse(tDate);
                if (in_date >= fDate && in_date <= tDate){
                    return true;
                }
                return false;
        
            }
            function featuresToDataSet(features){
                
                var dateSeries = [];
                var measureDataset = {
                        label:"Measurement",
                        data: [], borderWidth:1,borderColor:'#00ff00'
                    };
                var degradedDataset = {
                        label:"Degraded",
                        data: [], borderWidth:1,borderColor:'#ff0000'
                    };
                var threatenedDataset = {
                    label:"",
                    data: [], borderWidth:1,borderColor:'#ffff00'
                };
                for (var i in features){

                    var each = features[i];
                    if (each.attributes.Measurement == 0){
                        continue;
                    }
                    measureDataset.data.push(each.attributes.Measurement);
                    degradedDataset.data.push(each.attributes.Red);
                    threatenedDataset.data.push(each.attributes.Yellow);
                    const utcDate = new Date(each.attributes.Date); // UTC time
                    const localDate = new Date(utcDate.toDateString); // Converts to local time
                    dateSeries.push(utcDate.toDateString());
                   
                }
                var chartDataset ={
                    dateSeries: dateSeries,
                    dataSet:[measureDataset,degradedDataset,threatenedDataset]
                }
                return chartDataset;
            }
            function epoch_to_hh_mm_ss(epoch) {
                return new Date(epoch*1000).toISOString().substr(12, 7)
            }
            function InitChart(chartCtrl,chartType,labels, datasets,title){
                if (_chart) {
                    _chart.destroy();
                    }
                    _chart = new Chart(chartCtrl, {
                        type: chartType,
                        data: {
                        labels: labels,
                        datasets:datasets
                        },
                        options: {
                            plugins: {
                                title: {
                                    display: true, // Enable the title
                                    text: title, // The title text
                                    font: {
                                    size: 18, // Font size
                                    weight: 'bold' // Font weight
                                    },
                                    padding: {
                                    top: 10,
                                    bottom: 20
                                    },
                                    color: 'rgb(75, 192, 192)' // Text color
                                },
                                legend: {
                                labels: {
                                    color: 'rgb(75, 192, 192)', // Label text color
                                    font: {
                                    size: 18, // Font size
                                    family: 'Arial', // Font family
                                    },
                                    boxWidth: 20, // Width of the color box
                                    boxHeight: 10, // Height of the color box
                                    padding: 10, // Padding between legend items
                                    usePointStyle: true, // Use point style (e.g., circles)
                                },
                                },
                                // tooltip: {
                                //     callbacks: {
                                //     label: function(context) {
                                //         console.log(context);
                                //         var e = context.raw;
                                //     // e= e.replaceAll(",","");
                                //     var timeString = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                //     var label = "Measurement:"+ timeString
                                //         return label;
                                //     //  return new Date(context.formattedvalue).toTimeString();
                                //     }
                                //     }
                                // }
                            },
                           
                            scales: {
                            y:{
                                title:{
                                    display: true,
                                    text: 'Measurement',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14
                                    }
                                }
                            },
                            x:{
                                title:{
                                    display: true,
                                    text: 'Date',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14
                                    }
                                }
                            } 
                            
                            }
                        }
                    });
            }
            function InitScatterChart(chartCtrl,chartType,labels, datasets,title,scales){
                if (_chart) {
                    _chart.destroy();
                    }
                    _chart = new Chart(chartCtrl, {
                        type: chartType,
                        data: {
                        datasets:datasets
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                zoom: {
                                    pan: {
                                        enabled: true,
                                        mode: 'x',  // Allow panning in the x-axis
                                    },
                                    zoom: {
                                        wheel: {
                                        enabled: true, // Enable zooming with mouse wheel
                                        },
                                        pinch: {
                                        enabled: true // Enable zooming with pinch gestures
                                        },
                                        mode: 'x',  // Allow zooming in the x-axis
                                    }
                                },
                                legend: {
                                labels: {
                                    color: '#00ffc5', // Label text color
                                    font: {
                                        size: 18, // Font size
                                        family: 'Arial', // Font family
                                    },
                                    boxWidth: 20, // Width of the color box
                                    boxHeight: 10, // Height of the color box
                                    padding: 10, // Padding between legend items
                                    usePointStyle: true, // Use point style (e.g., circles)
                                },
                                },
                                // title: {
                                //     display: true, // Enable the title
                                //     text: title, // The title text
                                //     font: {
                                //             size: 18, // Font size
                                //             weight: 'bold' // Font weight
                                //     },
                                //     padding: {
                                //     top: 10,
                                //     bottom: 20
                                //     },
                                //     color: '#00ffc5' // Text color
                                // },
                                tooltip: {
                                    callbacks: {
                                    label: function(context) {
                                       // console.log(context);
                                         var e = context.raw.x; //Date time
                                         var y = context.raw.y; //measure value
                                    // // e= e.replaceAll(",","");
                                    var time = String(new Date(e).getHours()).padStart(2,'0') + ":"+ String(new Date(e).getMinutes()).padStart(2,'0') + ":"+String(new Date(e).getSeconds()).padStart(2,'0');
                                    var eventTime =  new Date(e).toDateString() + ' ' + time ;
                                    if(isDateWithinRange(y)){
                                        y = new Date(y).getHours() + ":"+ new Date(y).getMinutes() + ":"+new Date(y).getSeconds();
                                    }

                                     
                                     var label = "Measurement:"+ y
                                     label = label + ' at ' + eventTime;
                                         return label;
                                    //  return new Date(context.formattedvalue).toTimeString();
                                    }
                                    }
                                }
                            },
                           
                            scales: {
                            // y:{
                            //     title:{
                            //         display: true,
                            //         beginAtZero:true,
                            //         text: 'Measurement',
                            //         color: 'green',
                            //         font: {
                            //         size: 16,
                            //         weight: 'bold',
                            //         family: 'Verdana'
                            //         }
                            //     },
                            //     ticks:{
                            //         color: 'green',
                            //         font: {
                            //         size: 14
                            //         },
                            //         callback:(e,index,ticks)=>{
                            //             //console.log(ticks);
                            //             console.log(e);
                            //             if (isDateWithinRange(e)){
                            //                 var time = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                            //                 return time;
                            //             }
                            //             // if (e instanceof Date) {
                            //             //     console.log("It's a Date object!");
                            //             // } else {
                            //             //     console.log("It's not a Date object.");
                            //             // }
                            //             return e;
                            //         }
                            //     }
                            // },
                            x:{
                                type: 'time',
                                time: {
                                unit: 'week', // intervals: day, week, month, etc.
                                tooltipFormat: 'yyyy-MM-dd',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                                },

                                title:{
                                    display: true,
                                    text: 'Date',
                                    color: '#00ffc5',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: '#00ffc5',
                                    font: {
                                    size: 14
                                    },
                                    callback:function(e){
                                            //console.log('ticks:' + e)
                                            // var time = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                            // return  new Date(e).toDateString() + ' ' + time ;

                                            var now = new Date(e);
                                            var time = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                            const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                                            return  formattedDate + ' ' + time ;
                                        },
                                }
                            } 
                            
                            }
                        }
                    });
                    // Add a new scale dynamically
                    if (scales){
                            scales.forEach((each,i,scales)=>{
                            _chart.options.scales[each.id] = each.scale
                        })
                        _chart.update();
                    }
                    
                
            }
            function InitChartEventType(chartCtrl,chartType,labels, datasets,title){
                if (_chart){
                    _chart.destroy();
                }
                _chart = new Chart(chartCtrl, {
                        type: chartType,
                        data: {
                        labels: labels,
                        datasets:datasets
                        },
                        options: {
                            plugins: {
                                title: {
                                    display: true, // Enable the title
                                    text: title, // The title text
                                    font: {
                                    size: 18, // Font size
                                    weight: 'bold' // Font weight
                                    },
                                    padding: {
                                    top: 10,
                                    bottom: 20
                                    },
                                    color: 'rgb(75, 192, 192)' // Text color
                            },
                            tooltip: {
                                callbacks: {
                                label: function(context) {
                                    console.log(context);
                                    var e = context.raw;
                                   // e= e.replaceAll(",","");
                                   var timeString = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                   var label = "Measurement:"+ timeString
                                    return label;
                                  //  return new Date(context.formattedvalue).toTimeString();
                                }
                                }
                            }
                            },
                           
                            scales: {
                                x:{
                                title:{
                                    display: true,
                                    text: 'Date',
                                    color: 'green',
                                    font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                    }
                                },
                                ticks:{
                                    color: 'green',
                                    font: {
                                    size: 14,
                                    
                                    }
                                }
                            } ,
                                y:{
                                    ticks:{
                                        callback:function(e){
                                            //console.log('ticks:' + e)
                                            return  new Date(e).getHours() + ":"+ new Date(e).getMinutes() ;
                                        },
                                        color: 'green',
                                        font: {
                                        size: 14
                                        }

                                    },
                                    title:{
                                        display: true,
                                        text: 'Measurement',
                                        color: 'green',
                                        font: {
                                        size: 16,
                                        weight: 'bold',
                                        family: 'Verdana'
                                        }
                                    }
                                    
                                } 
                            
                            }
                        }
                    });
            }
            function readSelectedItems() {
                _exceptionTypes= [];
                var firstItem=null;
                const select = document.getElementById('selExceptionTypes');
                const allItems = Array.from(select.options).map(option => option.value);
                const selectedValues = Array.from(select.options)
                                            .filter(option => option.selected)
                                            .map(option => option.value);
                selectedValues.forEach((item,i,selectedValues)=>{                    
                    if (i==0){
                        firstItem = item;
                    }
                    if (!_exceptionTypes.includes(item)){
                        _exceptionTypes.push(item);
                    }
                })
                if (selectedValues.length == 0 && _exceptionTypes.length == 0){
                    _exceptionTypes.push(allItems[0]);
                }
                
                console.log("Selected items:", selectedValues);
            }
            function generateGraphScale(id,type,title,color){
                var defaultScale = {
                        id:id,
                        scale:{
                            title:{
                                display: true,
                                beginAtZero:true,
                                text: title,
                                color: color,
                                font: {
                                    size: 16,
                                    weight: 'bold',
                                    family: 'Verdana'
                                }
                            },
                            ticks:{
                                color: color,
                                font: {
                                size: 14
                                },
                                callback:(e,index,ticks)=>{
                                    //console.log(ticks);
                                    // console.log(e);
                                    if (isDateWithinRange(e)){
                                        var time = new Date(e).getHours() + ":"+ new Date(e).getMinutes() + ":"+new Date(e).getSeconds();
                                        return time;
                                    }
                                    // if (e instanceof Date) {
                                    //     console.log("It's a Date object!");
                                    // } else {
                                    //     console.log("It's not a Date object.");
                                    // }
                                    return e;
                                }
                            }
                        }
                    
                }
                
                return defaultScale;
            }
            function mergeDataSets(baseChartDataset,newChartDataset=null){
                let yId = baseChartDataset.dataSet.length;
                if (!newChartDataset && baseChartDataset.dataSet.length == 1){
                    baseChartDataset.dataSet[yId-1].yAxisID = 'y' + yId;
                    var yScale = generateGraphScale(baseChartDataset.dataSet[yId-1].yAxisID,'','Measurement',baseChartDataset.dataSet[yId-1].backgroundColor)
                    if (baseChartDataset.scales){
                        baseChartDataset.scales.push(yScale);
                    }
                    else{
                        baseChartDataset.scales= [yScale];
                    }
                    
                    return baseChartDataset;
                }
                var newMeasuredDataset = newChartDataset.dataSet[0];
                var newDegradedDataset = newChartDataset.dataSet[1];
                var newThreatenedDataset = newChartDataset.dataSet[2];
                var newDateSeries =  newChartDataset.dateSeries;

                baseChartDataset.dateSeries = baseChartDataset.dateSeries.concat(newDateSeries);
               // baseChartDataset.dataSet[1].data = baseChartDataset.dataSet[1].data.concat(newDegradedDataset.data);
                //baseChartDataset.dataSet[2].data = baseChartDataset.dataSet[2].data.concat(newThreatenedDataset.data);

                
                newMeasuredDataset.yAxisID = 'y' + (yId+1);
                //newMeasuredDataset.xAxisID = 'x' + yId;
                var yScale = generateGraphScale(newMeasuredDataset.yAxisID,'','Measurement',newMeasuredDataset.backgroundColor)
                if (baseChartDataset.scales){
                    baseChartDataset.scales.push(yScale);
                }
                else{
                    baseChartDataset.scales= [yScale];
                }
                
                baseChartDataset.dataSet = baseChartDataset.dataSet.concat(newMeasuredDataset);
                
                return baseChartDataset;

            }
            function getSliderRange() {
                var slider = document.getElementById("slider");
                var daterange ={
                    fdate:null,tdate:null
                }

                if (slider.noUiSlider) {
                    daterange.fdate = slider.noUiSlider.options.range.min;
                    daterange.tdate = slider.noUiSlider.options.range.max;
                  //  console.log("Current Min:", min, "Current Max:", max);
                    return daterange;
                } else {
                    console.warn("Slider is not initialized yet.");
                    return null;
                }
            }
            
            function selectedLoad(fDate,tDate){
                readSelectedItems();
                var fromDate;
                var toDate;
                
                if (!fDate && !tDate ){
                    fromDate = _currentDateRange.fDate;
                    toDate = _currentDateRange.tDate;
                }
                else{
                     fromDate = fDate;
                     toDate = tDate;
                }
                
                if (_exceptionTypes && _exceptionTypes.length > 0){
                   // var dateRange = getSliderRange();
                    
                    _exceptionTypes.forEach((exceptionType,i,_exceptionTypes)=>{
                        chartDataSet = csvToDatasetByException(_trendlineData,_locid,exceptionType,fromDate,toDate);
                        console.log(new Date(Date.now()).toTimeString())
                        console.log('Reading Selected Exception');
                        if (i==0){
                            chartDataSet.dataSet[0].backgroundColor = '#00FF00';
                           chartDataSet.dataSet[0].borderColor = '#00FF00';
                           _chartDataset =  mergeDataSets(chartDataSet);
                        }
                        else if (i==1){
                            chartDataSet.dataSet[0].backgroundColor = '#FFA500';
                           chartDataSet.dataSet[0].borderColor = '#FFA500';
                           _chartDataset =  mergeDataSets(_chartDataset,chartDataSet);
                        }
                        else if (i==2){
                           chartDataSet.dataSet[0].backgroundColor = '#FFC0CB';
                           chartDataSet.dataSet[0].borderColor = '#FFC0CB';
                           _chartDataset =  mergeDataSets(_chartDataset,chartDataSet);
                        }
                        else{
                            _chartDataset =  mergeDataSets(_chartDataset,chartDataSet);
                        }
                        console.log(new Date(Date.now()).toTimeString())
                        console.log('Merged Selected Exceptions');
                    });
                    const ctx = document.getElementById('myChart');
                    InitScatterChart(ctx,'scatter',_chartDataset.dateSeries.sort((a, b) => a - b),_chartDataset.dataSet,_exceptionTypes.join(','),_chartDataset.scales);
                    console.log(new Date(Date.now()).toTimeString());
                    console.log('displayed on Chart');
                }
            }
            function onLoad(){
                // if (!trendlineData && _trendlineData){
                //     trendlineData = _trendlineData;
                // }
                //readSelectedItems();
                const params = new URLSearchParams(window.location.search);
                _locid = params.get('locid')?params.get('locid'):'';  
                var chartDataset = {
                    exceptionType:'',
                    dataSet:[],
                    dateSeries:[]
                };
                
                console.log(new Date(Date.now()).toTimeString())
                console.log('Data Loaded');
                readAllExceptionTypes(_trendlineData,_locid);
                var fromDate = _dataDateRange.fDate;
                var toDate = _dataDateRange.tDate;

                chartDataSet = csvToDatasetByException(_trendlineData,_locid,_exceptionTypes[0],fromDate,toDate);
                
                //chartDataSet = csvToDataset(trendlineData,_locid,fromDate,toDate);
                console.log(new Date(Date.now()).toTimeString())
                console.log('Data Selected');

                const ctx = document.getElementById('myChart');
                InitScatterChart(ctx,'scatter',chartDataSet.dateSeries.sort((a, b) => a - b),chartDataSet.dataSet,_exceptionTypes.join(','));
                console.log(new Date(Date.now()).toTimeString())
                console.log('Data Plotted');
            }
            function initSlider(fDate,tDate){
                const slider = document.getElementById("slider");
                const sliderValue = document.getElementById("slider-value");
                
                const startDate = new Date(fDate).getTime();
                const endDate = new Date(tDate).getTime();
                // const startDate = new Date("2024-01-01T00:00:00").getTime();
                // const endDate = new Date("2024-12-31T23:59:59").getTime();
                
                function formatDateTime(timestamp) {
                    const date = new Date(Number(timestamp));
                    if (isNaN(date.getTime())) return "Invalid Date";
                    
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    
                    return `${year}-${month}-${day} ${hours}:${minutes}`;
                }
                if (slider.noUiSlider) {
                    slider.noUiSlider.updateOptions({
                        connect: true,
                        // range: {
                        //     min: startDate,
                        //     max: endDate
                        // },
                        start: [startDate,endDate] // Set to new start value
                    });
                    return;
                }
                
                noUiSlider.create(slider, {
                    start: [startDate,endDate],
                    connect: true,
                    range: {
                        'min': startDate,
                        'max': endDate
                    },
                    step: 3600, // One hour in milliseconds
                    // format: {
                    //     to: formatDateTime,
                       
                    //     from: value => {
                    //         const timestamp = Date.parse(value);
                    //         return isNaN(timestamp) ? startDate : timestamp;
                    //     }
                    // }
                });
                
                slider.noUiSlider.on("update", (values) => {
                    var from = formatDateTime(values[0]);
                    var to = formatDateTime(values[1]);
                   /// selectedLoad(values[0],values[1]);
                   _currentDateRange.fDate =from;
                   _currentDateRange.tDate = to;
                   slidervalue1.textContent = from;
                   slidervalue2.textContent = to;
                   // sliderValue.textContent = `Range: ${from} - ${to}`;
                });
            }
            
          </script>
          <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
    
            body, html {
                height: 100%;
                width: 100%;
                font-family: Arial, sans-serif;
                background-color: #121212;  /* Dark background */
                color: #00ffc5;             /* Light text */
            }
    
            #divChart {
                display: flex;
                flex-direction: row;
                height: 100vh;
                padding: 20px;
                gap: 20px;
            }
    
            /* Chart container styling */
            #divChart > div:first-child {
                flex: 3;
                display: flex;
                flex-direction: column;
            }
    
            canvas {
                
                background-color: #1e1e1e; /* Dark canvas background */
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            }
    
            /* Slider container styling */
            .slider-container {
                margin-bottom: 20px;
                background: #1e1e1e;
                padding: 15px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
                
            }
    
            #slider {
                width: 100%;
                height: 8px;
                background: #333;
                border-radius: 5px;
                position: relative;
                
                
            }
    
            .slider-values {
                display: flex;
                justify-content: space-between;
                margin-top: 17px;
                color:#4bc0c0
                
            }
    
            .slider-value1, .slider-value2 {
                font-size: 14px;
                color: #00ffc5
            }
    
            button {
                width: 100%;
                margin-top: 10px;
                padding: 10px 15px;                
                
                border: none;
                border-radius: 5px;
                background-color:#00ffc5;
                color: grey;
                cursor: pointer;
                transition: background-color 0.3s;
            }
    
            button:hover {
                background-color: #0056b3;
            }
    
            /* Exception list container styling */
            #divExcetpionList {                
                
                background: #1e1e1e;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
            }
    
            #divExcetpionList h3 {
                margin-bottom: 10px;
                color: #00ffc5;
            }
    
            select {
                /* flex: 2; */
                width: 100%;
                border: 1px solid #555;
                border-radius: 5px;
                padding: 10px;
                background-color: #2c2c2c;
                color: #00ffc5;
                font-size: 14px;
            }
    
            select option {
                padding: 5px;
                background-color: #2c2c2c;
                color: #00ffc5;
            }
    
            select option:hover {
                background-color: #007bff;
                color: #fff;
            }
    
        </style>
    </head>
    <body onload="readTrendlineData()">
        <div id="divChart">
            <!-- Left Section: Slider and Chart -->
            <div>
                <div class="slider-container">
                    <div id="slider"></div>
                    <div class="slider-values">
                        <div class="slider-value1" id="slidervalue1">Start: 0</div>
                        <div class="slider-value2" id="slidervalue2">End: 100</div>
                    </div>
                </div>
                <canvas id="myChart"></canvas>
            </div>
    
            <!-- Right Section: Exception List -->
            <div id="divExcetpionList">
                <button onclick="onDateChange()">Refresh</button>
                <br>
                <label for="selDataLimit">Max Records to Display</label>
                <select id="selDataLimit" style="height: fit-content;">
                    <option value="100">100</option>
                    <option value="2000">2000</option>
                    <option value="5000" selected >5000</option>
                    <option value="10000">10000</option>
                    <option value="100000">100000</option>
                </select>
                <h3>Exception Types</h3>
                <select id="selExceptionTypes" onchange="selectedLoad()" size="10" multiple>
                    <!-- Options will be dynamically populated -->
                </select>
            </div>
        </div>
    </body>
</html>
